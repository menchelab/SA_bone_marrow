---
title: "scNym clustering HSC DEG"
output: html_notebook
---

```{r}
knitr::opts_chunk$set(comment = '', fig.width = 6, 
                      fig.height = 6, echo = FALSE, 
                      warning = FALSE)
```


```{r, message = FALSE}
library(miloR)
library(SingleCellExperiment)
library(scater)
library(dplyr)
library(patchwork)
library(here)
library(scales)
library(scran)
library(tidyverse)
library(ggrepel)
library(rcartocolor)
library(circlize)
library(Seurat)

outdir = here("Rout")

source(here("R/functions.R"))

library(loomR)
```

### Getting scnym-based leiden mapping 

```{r}
l1_file = here("scfiles/SA_HSC_v2.loom")
lfile <- connect(filename = l1_file, mode = "r+", skip.validate = TRUE)

cattrnames = names(lfile$col.attrs)

SA.HSC.sample.annots = data.frame(leiden = lfile$col.attrs$leiden[])
for(attname in cattrnames) {
    SA.HSC.sample.annots[[attname]] = lfile$col.attrs[[attname]][]
}
lfile$close_all()
```

### Reading the raw data

```{r}
bm.final = readRDS(here("data/rds_files", "bm_final.rds") )
bm.final$batch = "final"
bm.pilot = readRDS(here("data/rds_files", "bm_pilot.rds") )
bm.pilot$batch = "pilot"

bm.merged = merge(bm.final, bm.pilot, project = "bm.merged")
```


### Running DEG
```{r}
lfc.limit = 0.5

clust.HSC.DE.list = list()

for (clust.id in unique(SA.HSC.sample.annots$leiden)) {
    cat("cluster", clust.id, "\n")

    cluster.subset = hvg.subset.HSC[, hvg.subset.HSC$Mariem_annotation == clust.id ]

    cluster.raw.counts = bm.merged[rownames(bm.merged), 
                                   intersect(rownames(bm.merged@meta.data),
                                             SA.HSC.sample.annots$obs_names)]
    
    bm.merged.metadata = bm.merged@meta.data %>% 
        mutate(condition = gsub("HTO-([A-Z]+)[0-9]", "\\1", sample))
    
    bm.merged.metadata = bm.merged.metadata[colnames(cluster.raw.counts), ] 
    
    cluster.subset.deseq = DESeqDataSetFromMatrix(cluster.raw.counts@assays$RNA@counts + 1,
                                                   colData = bm.merged.metadata,
                                                   design = ~ condition + batch)
    cluster.DE = pseudobulk_DEseq2(cluster.subset.deseq)

        # rld = rlog(cluster.subset.deseq, blind = FALSE)
        # assay(rld) <- limma::removeBatchEffect(assay(rld), rld$batch)

    clust.HSC.DE.list[[clust.id]] = cluster.DE
    # MA.cluster.normed.data[[clust.id]] =  rld
    
    cluster.DE = cluster.DE %>% filter(padj < 0.05, abs(log2FoldChange) > lfc.limit )
    clust.HSC.DE.list[[clust.id]] = cluster.DE
    
    cluster.DE %>% rename(names = gene) %>% rownames_to_column() %>%
        openxlsx::write.xlsx(file = here(paste0("DEG_sheets/cluster", clust.id, ".HSC.DEG.SAvsPBS.19.08.2024.xlsx")))

    add_mouse_geneinfo(here(paste0("DEG_sheets/cluster", 
                                   clust.id, ".HSC.DEG.SAvsPBS.19.08.2024.xlsx")))
}
```

## Getting module scores

I decided to calculate the module scores for the batches separately, to not 
counfound the modulescores by batch effects.

### Module scores for EOS paper Jorssen et al 2024 Immunity Table 2

#### Reading table 2

```{r}
table2.files.dir = here("eos_maturation_paper_data/table_S2_markers/")

cell.type.genes = list()

for (csv.file in list.files(path = table2.files.dir, pattern = "*.csv", full.names = FALSE)) {
    cell.type = gsub(".csv", "", csv.file)
    cat(cell.type, "\n")
    cell.type.genes[[cell.type]] = read.table(
        file.path(table2.files.dir, csv.file),
        sep = "\t", h = T)
}

table2.gene.features = sapply(cell.type.genes, function(x) x$Gene)
```

#### Reading table 5

```{r}
table5.files.dir = here("eos_maturation_paper_data/table_S5_markers/")

cell.type.genes = list()

for (csv.file in list.files(path = table5.files.dir, pattern = "*.csv", full.names = FALSE)) {
    cell.type = gsub(".csv", "", csv.file)
    cat(cell.type, "\n")
    cell.type.genes[[cell.type]] = read.table(
        file.path(table5.files.dir, csv.file),
        sep = "\t", h = T)
}

table5.gene.features = sapply(cell.type.genes, function(x) x$Gene)
```

#### Reading gene features extracted by the Quant-seq experiment

```{r}
quantseq.DEGs = read_excel_allsheets(here("../SA_Quantseq2/outputs/DE.genes.SAvsPBS.xlsx"))
gene.score.features = sapply(quantseq.DEGs, function(x) x %>% filter(padj < 0.05) %>% pull(gene_name))
```

#### Reading cytopus gene sets 

```{r}
cytopus.dir = here("cytopus_cell_types")
cytopus.gene.sets = list()
for (filename in list.files(cytopus.dir)) {
    # cellname = gsub(".dat", "", filename)
    cellname = filename
    cytopus.gene.sets[[cellname]] = readLines(file.path(cytopus.dir, filename))
}
```


Calculating the modulescores for pilot and final experiments:

```{r}
bm.pilot = AddModuleScore(bm.pilot, table2.gene.features, 
                                name = names(table2.gene.features))
bm.final = AddModuleScore(bm.final, table2.gene.features, 
                                name = names(table2.gene.features))


bm.pilot = AddModuleScore(bm.pilot, table5.gene.features, 
                                name = names(table5.gene.features))
bm.final = AddModuleScore(bm.final, table5.gene.features, 
                                name = names(table5.gene.features))


bm.pilot = AddModuleScore(bm.pilot, gene.score.features, 
                                name = names(gene.score.features))
bm.final = AddModuleScore(bm.final, gene.score.features, 
                                name = names(gene.score.features))


bm.pilot = AddModuleScore(bm.pilot, cytopus.gene.sets, 
                                name = names(cytopus.gene.sets))
bm.final = AddModuleScore(bm.final, cytopus.gene.sets, 
                                name = names(cytopus.gene.sets))
```
### Merging the bm final and bm pilot scores

```{r}
bm.modulescore.merged = merge(bm.pilot, bm.final, project = "modulscoring")
SA.HSC.modulescore.bm = bm.modulescore.merged[, SA.HSC.sample.annots$obs_names ]
```

### Writing the modulescores for quantseq gene sets

```{r}
quantseq.modulescores = SA.HSC.modulescore.bm@meta.data[, c("Eosinophil1" , 
                                       "Neutrophil2" , 
                                       "Neutrophil_progenitor3"  ,        
                                       "Eosinophil_progenitor4", 
                                       "Granulocyte_Monocyte_progenitor5",
                                       "Common_Myeloid_progenitor6")] %>% 
    rename_with(~str_remove(.x, "[0-9]$"))

write.csv(quantseq.modulescores,
          file = here("Rout/SA.HSC.Quantseq.modulescores.csv"))
```

### Writing the modulescores for cytopus gene sets

```{r}
cytopus.modulescores = SA.HSC.modulescore.bm@meta.data %>% 
    select(abT.dat1:TSCM.dat53) %>% 
    rename_with(~str_remove(.x, ".dat[0-9]{1,2}$"))

write.csv(cytopus.modulescores,
          file = here("Rout/SA.HSC.cytopus.modulescores.csv"))
```


### Writing the modulescores for Jorssen et al 2024 gene sets

```{r}
table2.modulescores = SA.HSC.modulescore.bm@meta.data %>% 
    select(basophil1:neutrophil8) %>% 
    rename_with(~str_remove(.x, "[0-9]$"))

write.csv(table2.modulescores,
          file = here("Rout/SA.HSC.table2.modulescores.csv"))


table5.modulescores = SA.HSC.modulescore.bm@meta.data %>% 
    select(eos_stage11:eos_stage55) %>% 
    rename_with(~str_remove(.x, "[0-9]$"))

write.csv(table5.modulescores,
          file = here("Rout/SA.HSC.table5.modulescores.csv"))
```
